<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aspect Blockchain | Direct Debit Admin</title>
  <link rel="stylesheet" href="admin.css" />
</head>
<body>
  <!-- ‚úÖ NAVBAR -->
  <nav class="navbar">
    <div class="logo-area">
      <img src="aspect-logo.png" alt="Aspect Blockchain Logo" class="logo" />
      <h1>Aspect Blockchain | Direct Debit Admin</h1>
    </div>
    <div class="user-info">Admin Panel</div>
  </nav>

  <!-- ‚úÖ MAIN CONTAINER -->
  <main class="container">
    <!-- üîç CUSTOMER LOOKUP -->
    <section class="card">
      <h2>Customer Lookup</h2>
      <input type="text" id="search-query" placeholder="Enter customer name or email" />
      <button id="search-btn">Search</button>
      <div id="search-results"></div>
    </section>

    <!-- üßæ GENERATE DIRECT DEBIT LINK -->
    <section class="card">
      <h2>Generate Direct Debit Setup Link</h2>
      <input type="text" id="customer_id" placeholder="Enter Stripe Customer ID (cus_...)" />
      <button id="generate-link">Generate Link</button>
      <p id="link-result" class="result-text"></p>
    </section>
  </main>

  <!-- ‚úÖ FOOTER -->
  <footer>
    <p>¬© 2025 Aspect Blockchain Group ‚Äî Infrastructure | Mining | Logistics</p>
  </footer>

  <!-- ‚úÖ JAVASCRIPT -->
  <script>
    // --- Generate Direct Debit Link ---
    document.getElementById("generate-link").addEventListener("click", async () => {
      const customerId = document.getElementById("customer_id").value.trim();
      const result = document.getElementById("link-result");

      if (!customerId) {
        result.textContent = "‚ö†Ô∏è Please enter a Customer ID.";
        return;
      }

      result.textContent = "‚è≥ Generating link...";
      try {
        const res = await fetch(`/create-directdebit-session?customer_id=${customerId}`);
        const data = await res.json();

        if (data.url) {
          result.innerHTML = `‚úÖ <a href="${data.url}" target="_blank">${data.url}</a>`;
          saveLinkToHistory(data.url);
        } else {
          result.textContent = "‚ö†Ô∏è Failed to generate link.";
        }
      } catch (err) {
        console.error("Error:", err);
        result.textContent = "‚ùå Error generating link. Check console.";
      }
    });

    // --- Search Customers ---
    document.getElementById("search-btn").addEventListener("click", async () => {
      const query = document.getElementById("search-query").value.trim();
      const resultsContainer = document.getElementById("search-results");

      if (!query) {
        resultsContainer.innerHTML = "<p>‚ö†Ô∏è Enter a name or email to search.</p>";
        return;
      }

      resultsContainer.innerHTML = "<p>‚è≥ Searching...</p>";
      try {
        const res = await fetch(`/search-customers?q=${encodeURIComponent(query)}`);
        const data = await res.json();

        if (data.length === 0) {
          resultsContainer.innerHTML = "<p>‚ùå No customers found.</p>";
          return;
        }

        resultsContainer.innerHTML = data
          .map(
            (c) => `
            <div class="customer">
              <p><strong>${c.name || "(No name)"}</strong><br>${c.email || ""}</p>
              <button onclick="copyLink('${c.id}')">Copy Setup Link</button>
            </div>`
          )
          .join("");
      } catch (err) {
        console.error("Search error:", err);
        resultsContainer.innerHTML = "<p>‚ùå Error fetching results.</p>";
      }
    });

    // --- Copy Link Helper ---
    async function copyLink(customerId) {
      const res = await fetch(`/create-directdebit-session?customer_id=${customerId}`);
      const data = await res.json();
      if (data.url) {
        navigator.clipboard.writeText(data.url);
        alert("‚úÖ Link copied to clipboard!");
        saveLinkToHistory(data.url);
      } else {
        alert("‚ö†Ô∏è Failed to generate link.");
      }
    }

    // --- Link History (client side only) ---
    function saveLinkToHistory(url) {
      let history = JSON.parse(localStorage.getItem("generatedLinks") || "[]");
      history.unshift({ url, date: new Date().toLocaleString() });
      history = history.slice(0, 3);
      localStorage.setItem("generatedLinks", JSON.stringify(history));
      renderLinkHistory();
    }

    function renderLinkHistory() {
      const history = JSON.parse(localStorage.getItem("generatedLinks") || "[]");
      const container = document.getElementById("link-history");
      if (!container) return;
      if (history.length === 0) {
        container.innerHTML = "<p>No recent links.</p>";
        return;
      }
      container.innerHTML = history
        .map(
          (h) =>
            `<p>üîó <a href="${h.url}" target="_blank">${h.url}</a><br><small>${h.date}</small></p>`
        )
        .join("");
    }

    window.onload = renderLinkHistory;
  </script>
</body>
</html>