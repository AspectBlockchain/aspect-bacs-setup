<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aspect Blockchain | Direct Debit Admin</title>

  <!-- ✅ Link to branded CSS -->
  <link rel="stylesheet" href="admin.css" />

  <!-- Optional favicon + color -->
  <link rel="icon" type="image/png" href="https://i.ibb.co/THzh7L1/aspect-logo.png" />
  <meta name="theme-color" content="#0abfdc">
</head>
<body>
  <!-- ================= NAVBAR ================= -->
  <nav class="navbar">
    <div class="logo-area">
      <img src="https://i.ibb.co/THzh7L1/aspect-logo.png" alt="Aspect Blockchain" class="logo" />
      <h1>Aspect Blockchain | Direct Debit Admin</h1>
    </div>
    <div class="user-info">Admin Panel</div>
  </nav>

  <!-- ================= MAIN ================= -->
  <main>
    <h2>Customer Lookup</h2>

    <form id="search-form">
      <input type="text" id="searchQuery" placeholder="Enter customer name or email" required />
      <button type="submit">Search</button>
    </form>

    <div id="results"></div>

    <h2>Generate Direct Debit Setup Link</h2>

    <form id="link-form">
      <input type="text" id="customerId" placeholder="Enter Stripe Customer ID (cus_...)" required />
      <button type="submit">Generate Link</button>
    </form>

    <div id="link-output"></div>
    <div id="log" style="margin-top: 30px;"></div>
  </main>

  <!-- ================= FOOTER ================= -->
  <footer>
    © 2025 Aspect Blockchain Group — Infrastructure | Mining | Logistics
  </footer>

  <!-- ================= SCRIPT ================= -->
  <script>
    const searchForm = document.getElementById("search-form");
    const linkForm = document.getElementById("link-form");
    const resultsDiv = document.getElementById("results");
    const linkOutput = document.getElementById("link-output");
    const logDiv = document.getElementById("log");

    // ---------- LOGIN ----------
    async function login() {
      const username = prompt("Enter username:");
      const password = prompt("Enter password:");

      const res = await fetch("/admin-login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ username, password }),
      });

      if (!res.ok) {
        alert("❌ Invalid credentials.");
        throw new Error("Unauthorized");
      }

      const data = await res.json();
      localStorage.setItem("authToken", data.token);
    }

    // ---------- SEARCH ----------
    searchForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const query = document.getElementById("searchQuery").value;
      resultsDiv.innerHTML = "<p class='loading'>Searching...</p>";

      try {
        const res = await fetch(`/search-customers?query=${encodeURIComponent(query)}`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` },
        });

        if (res.status === 401) {
          await login();
          return searchForm.dispatchEvent(new Event("submit"));
        }

        const data = await res.json();
        if (!data.length) {
          resultsDiv.innerHTML = "<p>No customers found.</p>";
          return;
        }

        resultsDiv.innerHTML = data
          .map(
            (c) => `
            <div class="customer-card">
              <strong>${c.name || "Unnamed Customer"}</strong><br>
              ${c.email || "No email"}<br>
              <span>${c.id}</span>
            </div>`
          )
          .join("");
      } catch (err) {
        console.error(err);
        resultsDiv.innerHTML = "<p class='error'>Error fetching customers.</p>";
      }
    });

    // ---------- GENERATE SETUP LINK ----------
    linkForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const customerId = document.getElementById("customerId").value;
      linkOutput.innerHTML = "<p class='loading'>Generating link...</p>";

      try {
        const res = await fetch(`/create-directdebit-session?customer_id=${customerId}`, {
          headers: { Authorization: `Bearer ${localStorage.getItem("authToken")}` },
        });

        if (res.status === 401) {
          await login();
          return linkForm.dispatchEvent(new Event("submit"));
        }

        const data = await res.json();

        if (data.url) {
          linkOutput.innerHTML = `
            <p>✅ Link created:</p>
            <p><a href="${data.url}" target="_blank">${data.url}</a></p>`;
        } else {
          linkOutput.innerHTML = `<p class='error'>⚠️ Failed to generate link.</p>`;
        }
      } catch (err) {
        console.error("Fetch error:", err);
        linkOutput.innerHTML = "<p class='error'>⚠️ Server error while generating link.</p>";
      }
    });
  </script>
</body>
</html>